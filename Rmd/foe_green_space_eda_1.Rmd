---
title: "foe_green_space_eda_1"
output: 
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(readxl)
library(RColorBrewer)
library(cowplot)
library(gt)

theme_set(theme_minimal())

```

## Objectives


## Context

**National: **

* Funding challenges parks
* Housing shortages
* Leveling up agenda


**Personal: **

* 

## The Friends of the Earth Report - "England’s Green Space Gap"

* Friends of the Earth (FoE) recently released a report detailing their research into "England’s Green Space Gap".
* As part of their research FoE developed a new approach for classifying the extent of green space deprivation across English neighbourhoods (i.e. English MSOAs).
* Neighbourhoods are classified into five groups - A (least green space deprived), B, C, D and E (most green space deprived).
* This classification is based on analysis of two datasets from the ONS detailing: (1) the amount garden space; and, (2) the accessibility of public green spaces (parks etc.).
* In the report, FOE also draw on the ONS Index of Multiple Deprivation (IMD) dataset to explore the relationship between green space deprivation and demographic factors (including ethnicity and income).
* FoE have released the dataset which informs the "England’s Green Space Gap" report. This dataset includes the FoE green space classification for each English neighborhood, alongside IMD data.
* Reading the report and exploring the associated dataset, I was struck by a number of questions about the nature and scope of green space deprivation in England. I thought that these questions might be a good basis for an exploratory data analysis, which might extend upon the FoE analysis and contribute to the wider debate on maintaining and extending access to green space during the post-covid recovery.

## Questions for Exploratory Data Analysis

**Where is green space deprivation experienced?**

* *Green space deprivation: *
  + What is the scale of the green space deprivation problem in England?
    - How many neighborhoods could be considered green space deprived?
    - How many people live in green space deprived neighborhoods?
    - How are FoE's green space deprivation ratings distributed?
  + [Is green space deprivation an urban problem? 2001 classification](https://geoportal.statistics.gov.uk/datasets/rural-urban-classification-2001-of-msoas-in-england-and-wales)?
    - Have FoE defined green space deprivation as an urban problem?
    - Does the underpinning data justify this? 
  + How do the two dimensions of green space deprivation (availability of garden space and accessibility of public green space) relate to each other?
    - Is there a trade-off between garden space and access to public green space?
  + How is green space deprivation distributed across regions and a local authorities in England?
    - Where are the cities/regions where action is most needed?
    - Which local authorities have the highest/lowest proportion of D and E rated neighborhoods?
    
**Who is living with green space deprivation?**

* *Ethnicity and green space deprivation: *
  + Are people from a BAME background  more likely, than white people, to experience green space deprivation?
  + Is the proportion of BAME population within an MSOA associated with the MSOA's green space deprivation rating?
* *Age and green space deprivation: *
  + Are different age groups more or less likely to experience green space deprivation?
* *Wealth and green space deprivation: *

**The relationship between green space deprivation and health?**

* *Covid and green space deprivation: *
  + Have populations living in green space deprived area experienced a greater covid-19 burden, relative to people living in green space affluent areas.
* *Life expectancy and green space deprivation: *

**Ideas: **

* Plot idea - garden space vs. access to public green space - colour by rating ...
* Use above and below median income to facet plots (as in covid-19) ... 
* Is there an equivalent approach for ethnicity? Where might the boundary be drawn (the national average proportion of BAME population)?
* Green space affluent vs. green space deprived?


## Data sources used
```{r}

data_sources <- tribble(
  ~file_name, ~name, ~notes, ~url,
  "(FOE) Green Space Consolidated Data - England - Version 2.1.xlsx", "green_space", "...", "https://friendsoftheearth.uk/nature/green-space-consolidated-data-england",
  "Local_Authority_District_to_Region__December_2019__Lookup_in_England.csv", "LAD_to_region", "used the December 2019 version", "https://geoportal.statistics.gov.uk/datasets/3ba3daf9278f47daba0f561889c3521a_0"
)

data_sources

```

Local Authority District to Region lookup (December 2019 used) - https://geoportal.statistics.gov.uk/datasets/3ba3daf9278f47daba0f561889c3521a_0

```{r}
green_space <- read_excel("../Data/(FOE) Green Space Consolidated Data - England - Version 2.1.xlsx",
                          sheet = "MSOAs V2.1")

green_space

# FOE green space data doesn't include a variable for the region each MSOA/local authority lies within
# So, import a look up table from the ONS, which maps between Local Authority Districts and Regions
LAD_to_region <- read_csv("../Data/Local_Authority_District_to_Region__December_2019__Lookup_in_England.csv") %>% 
  select(-FID, -LAD19NM)

LAD_to_region

# add region names and codes (from ONS look up) to FOE green space data
green_space <- green_space %>% 
  left_join(LAD_to_region, by = c("LA_Code" = "LAD19CD")) %>% 
  relocate(RGN19CD, RGN19NM, .before = Area) %>% 
  rename(region_code = RGN19CD,
         region_name = RGN19NM)

green_space
```

```{r}


```





## The distribution of green space deprivation ratings across England

```{r}
library(janitor)

green_space %>% 
  tabyl(Green_Space_Deprivation_Rating)
```



```{r}
# for each green space deprivation rate calculate the numbers and proportions of msoas
msoa_by_rating <- green_space %>% 
  tabyl(Green_Space_Deprivation_Rating) %>% 
  rename(n_msoa = n,
         percent_msoa = percent)

# for each green space deprivation rate calculate the numbers and proportions of the population
pop_by_rating <- green_space %>% 
  group_by(Green_Space_Deprivation_Rating) %>% 
  summarise(population = sum(Population_IMD)) %>% 
  
  ungroup() %>% 
  mutate(percent_pop = population / sum(population))

# merge the msoa and population tables
msoa_and_pop_by_rating <- msoa_by_rating %>% 
  left_join(pop_by_rating, by = c("Green_Space_Deprivation_Rating" = "Green_Space_Deprivation_Rating"))

msoa_and_pop_by_rating %>%
  
  add_column(group = c(1,1,1,2,2)) %>% 
  arrange(desc(Green_Space_Deprivation_Rating)) %>% 
  
  gt(rowname_col = "Green_Space_Deprivation_Rating", groupname_col = "group") %>%
  
    summary_rows(
    groups = TRUE,
    columns = vars(population),
    fns = list(
      total = ~sum(.)),
    formatter = fmt_number,
    scale_by = 1e-6) %>%
  
    summary_rows(
    groups = TRUE,
    columns = vars(n_msoa),
    fns = list(
      total = ~sum(.)),
    formatter = fmt_number,
    ) %>%
  
  summary_rows(
    groups = TRUE,
    columns = vars(percent_msoa, percent_pop),
    fns = list(
      total = ~sum(.)),
    formatter = fmt_percent,
    ) %>%
  
  tab_stubhead(label = html("Green Space<br>Deprivation <br>Rating")) %>%
  
  fmt_percent(starts_with("percent_"), decimals = 0) %>%
  fmt_number(vars(population), scale_by = 1e-6) %>% 

  # cols_merge(columns = vars(n_msoa, percent_msoa),
  #            pattern = "{1} ({2})") %>% 
  # cols_merge(columns = vars(population, percent_pop),
  #            pattern = "{1} ({2})") %>% 

  
  cols_label(n_msoa = "Neighbourhoods",
             population = "Population (Millions)")
  
```



```{r}
gs_bar <- function(){
  
  list(
      geom_col(),
      
      scale_fill_manual(values = colour_scale),
      
      geom_text(mapping = aes(label = bar_label), hjust = 1.1, colour = "white", size = 3.5),
      
      guides(fill = FALSE),
      
      theme(axis.text.x = element_text(face = "bold"),
            axis.text.y = element_text(face = "bold", size = 15),
            plot.title = element_text(face = "bold", size = 15)
            ),
      
      coord_flip()
  )
  
}

bar_labels <- c("Large or very large gardens and large or \nvery large amounts of public green space",
                           "",
                           "",
                           "",
                           "Very small gardens and very small\namounts of public green space")

x_lab <-  "Green space deprivation rating\n\n"
caption_lab <-  "Source: Friends of the Earth, England's Green Space Gap"

colour_palette <- scales::seq_gradient_pal(low = "palegreen4", high = "grey")
colour_scale <- colour_palette(seq(0, 1, length.out = 5))

```

```{r}
p <- ggplot(data = msoa_and_pop_by_rating,
            mapping = aes(x = Green_Space_Deprivation_Rating, 
                          y = msoa_count,
                          fill = Green_Space_Deprivation_Rating)
            )

p + gs_bar() +
  
  labs(title = "Numbers of neighbourhoods in England by green space\ndeprivation rating\n",
       x = x_lab,
       y = "\nNumber of Neighbourhoods\n",
       caption = caption_lab) 

```


Below I plot the proportions of the `r sum(msoa_by_rating$msoa_count)` MSOAs analyzed given each green space deprivation rating. 

* Approximately 30% of the `r sum(msoa_by_rating$msoa_count)` MSOAs rated are given one of the highest two ratings for green space deprivation , D (16.3%) and E(14.1%);
* While 24.2% of MSOAs received the lowest rating (A). Approximately 44% of MSOAs receive one of the lowest two rating (A or B).
* The most commonly occurring rating is C (25.4% of MSOAs), which includes neighbourhoods which are neither relatively deprived or affluent in terms of access to green space.
* Overall, there are more relatively green space affluent neighborhoods in England (rated A and B), than there are relatively green space deprived neighborhoods (rated D and E).
* 

```{r}
p <- ggplot(data = msoa_and_pop_by_rating,
            mapping = aes(x = Green_Space_Deprivation_Rating, 
                          y = prop_msoa,
                          fill = Green_Space_Deprivation_Rating)
            )

p + gs_bar() +

  labs(title = "Proportion of neighbourhoods in England by green space\ndeprivation rating\n",
       x = x_lab,
       y = "Proportion of neighbourhoods",
       caption = caption_lab)
  

msoa_by_rating
```



```{r}

p <- ggplot(data = msoa_and_pop_by_rating,
            mapping = aes(x = Green_Space_Deprivation_Rating,
                          y = population,
                          fill = Green_Space_Deprivation_Rating)
            )

p + gs_bar() +
  
  labs(title = "The population living within neighbourhoods with each\ngreen space deprivation rating\n",
       y = "\nPopulation",
       x = x_lab)

```



## The distribution of green space deprivation ratings across the regions

The two plots below, respectively show for each region the numbers or proportion of MSOA with each green space deprivation rating. Key insights from the two plots include:

* Over 45% of London's MSOAs have been given the lowest rating (E). A further approximately 30% of London's MSOAs are rated are rated D;
* In the other regions (excluding London), the proportion of MSOAs with the lowest rating (E) in each is in the range of approximately 5-15%. The demonstrates that green space deprivation is a nationwide issue, that is perhaps unsurprisingly prominent in London (the largest city)
* The North-East and the North-West have very similar distributions of MSOA green space deprivation ratings. With the a fairly symetrical and bell shaped distribution, centred on the C rating. Perhap reflecting a mix
* The East of England, the South East and the South West have similar distribution, where the most commonly occurring rating is A.
* Overall, there are considerable inequities within each region in terms of access to green space. All regions include a mix of green space deprived and affluent neighbourhoods.

```{r}

msoa_by_region_and_rating <- green_space %>% 
  
  # count by region and rating
  group_by(region_name, Green_Space_Deprivation_Rating) %>% 
  summarise(msoa_count = n()) %>% 
  filter(!is.na(region_name)) %>% 
  ungroup() %>% 

  # calculate rating proportions by region
  group_by(region_name) %>% 
  mutate(prop = msoa_count / sum(msoa_count)) %>% 
  ungroup()

msoa_by_region_and_rating

plot_msoas_by_region <-  function(y_var){
  
  p <- ggplot(data = msoa_by_region_and_rating,
            mapping = aes(x = Green_Space_Deprivation_Rating, y = .data[[y_var]])
            )

  p + geom_bar(mapping = aes(fill = Green_Space_Deprivation_Rating),
             stat = "identity",
             colour = "grey80") +
  
  scale_fill_brewer(type = "div",
                    palette = "RdYlGn",
                    direction = -1) +
  
  guides(fill = FALSE) +
  
  coord_flip() +
  
  facet_wrap(~ region_name, ncol = 3)
}

plot_msoas_by_region("msoa_count")
plot_msoas_by_region("prop")

```
```{r}

```


Below I plot again plot the proportion of MSOAs within each region receiving each green space deprivation rating. This time faceting the plot by green space deprivation rating rather than region. This makes it easier to compare across regions at a given rating. 

* So we can clearly see the South East and Southwest have higher proportions of A rated MSOAs than say the North East and North West.
* While outside of London, within each region there are similar proportion of neighbourhoods receiving the two highest green space deprivation ratings (D and E).

It would be easier to read if I produced separate plots for each green space deprivation rating, as then the regions could be put in rank order.

```{r}
prop_a <- msoa_by_region_and_rating %>%
  filter(Green_Space_Deprivation_Rating == "A") %>% 
  mutate(prop_a = prop) %>% 
  select(region_name, prop_a)

msoa_by_region_and_rating <- msoa_by_region_and_rating %>% 
  left_join(prop_a)
  
msoa_by_region_and_rating  

p <- ggplot(data = msoa_by_region_and_rating,
            mapping = aes(x = reorder(region_name, prop_a), y = prop, fill = region_name)
            )

p + geom_bar(stat = "identity") +
  facet_wrap(~ Green_Space_Deprivation_Rating) +
  
  guides(fill = FALSE) +
  
  coord_flip()
```
Next I explored an alternative appraoch to considering the distribution of msoas by rating and region. I plotted the proportion of MSOAs that received a specific rating by region. In order to address the ordering issue above, I produced one plot for each green space rating. This meant addressing the challenge of how to ensure the colour associated with a given region was applied consistently across the five plots. Here is where I found the an approach to doing this, using scale_..._manual.

[How to map a colour to a value of a categorical variable ...](https://www.stat.ubc.ca/~jenny/STAT545A/block17_colorsGgplot2Qualitative.html)

This approach help me identify some additional insights:

* For the highest green space deprivation ratings (D and E), the ranking of regions is the same: (1) London, (2) North West, (3) South East, (4) Yorkshire and the Humber and (5) West Midlands.
* Over half of MSOAs given the highest green space deprivation rating are accounted for by just two regions: (1) London and (2) the North West.
* 


```{r}
# The idea is to produce one bar chart for each green space rating, and across these plots use the same colour for a given region. 
# choose a palette to work with
region_pal <- brewer.pal(9, "Paired")

# map the region names to a specific colour value (in a dataframe for ease)
region_colours_df <- msoa_by_region_and_rating %>% 
  select(region_name) %>% 
  distinct(region_name) %>% 
  add_column(colour = region_pal)

# convert the region-colour mapping from a dataframe to a vector
# because a vector is required by scale_fill_manual
region_colours_vector <- region_colours_df$colour
names(region_colours_vector) <- region_colours_df$region_name
region_colours_vector


plot_gsdr_prop_by_region <- function(rating = "A"){
  
    msoa_by_region_and_rating %>%
      
    # focus on the rating of interest
    filter(Green_Space_Deprivation_Rating == rating) %>% 
    mutate(proportion = msoa_count / sum(msoa_count)) %>%
    
    # create the bar chart
    ggplot(mapping = aes(x = reorder(region_name, proportion), 
                         y = proportion,
                         fill = region_name
                         )
           ) +
      
    geom_col() +
    
    # apply region-colour mapping  
    scale_fill_manual(values = region_colours_vector) +
    
    guides(fill = FALSE) +
      
    labs(title = str_c("MSOAs receiving green space deprivation rating: ", rating),
         x = NULL,
         y = str_c("Proportion of the MSOAs that recieved a rating of ", rating)
         ) +
    
    coord_flip()
}


# produce one plot for each of the five green space deprivation ratings
gsdr_prop_by_region_plots <- c("A", "B", "C", "D", "E") %>% 
  map(~ plot_gsdr_prop_by_region(.x))

gsdr_prop_by_region_plots

```
```{r, fig.width = 12.5, fig.height=7}

d_plot <- gsdr_prop_by_region_plots[[4]] + 
  ylim(0, 0.45) # ensure the plot axis scales match
  
e_plot <- gsdr_prop_by_region_plots[[5]] + 
  ylim(0, 0.45) # ensure the plot axis scales match

plot_grid(d_plot, e_plot, ncol = 2)
```


Could do ridgeline plots for each region - for prop rated A and proportion rated E

## The geographic distribution of green space deprivation ratings

https://datacarpentry.org/r-raster-vector-geospatial/06-vector-open-shapefile-in-r/

```{r, eval=FALSE}
library(sf)

msoa_sf <- st_read("../Data/Middle_Layer_Super_Output_Areas/Middle_Layer_Super_Output_Areas__December_2011__Boundaries_EW_BFE.shp")

# msoa_sf <- raster::shapefile("../Data/Middle_Layer_Super_Output_Areas/Middle_Layer_Super_Output_Areas__December_2011__Boundaries_EW_BFE.shp")



msoa_sf_gs <- msoa_sf %>% 
  left_join(green_space, by = c("MSOA11CD" = "MSOA_Code"))



```

A quick visual inspection of the MSOAs colored by their green space deprivation rating, shows a similiar patter across the regions (with the exception of London). With the the D and E ratings (oranges and reds) occurring in smaller (presumably more densely populated MSOAs) which make up urban areas. While the larger, more rural MSOAs tend to be less green space deprived, and have A or B ratings. Given the whole region of London would probably be considered a continuous urban space, it is unsurprising to observe many green space deprived MSOAs across the region/plot, with relatively few less green space deprived areas present.

```{r, fig.width=10, eval=FALSE}

green_space_region_plot <- function(region){

  p <-  ggplot(data = msoa_sf_gs %>% 
                 filter(region_name == region),
               mapping = aes(fill = Green_Space_Deprivation_Rating)
               )
  
  p + geom_sf(colour = "grey75") +
    
    scale_fill_brewer(type = "div",
                      palette = "RdYlGn",
                      direction = -1) +
    
    labs(title = str_c("...", region))
}

region_names <- green_space %>%
  select(region_name) %>% 
  distinct(region_name)

region_names %>%
  filter(!is.na(region_name)) %>% 
  pmap(~ green_space_region_plot(region = .x))
  
```

# Ethnicity and green space deprivation

```{r}
green_space <- green_space %>% 
  mutate(prop_BAME_pop = BAME_Pop / Total_Pop_From_Ethnicity_Data) %>%
  relocate(prop_BAME_pop, .after = BAME_Pop)

p <- ggplot(data = green_space,
            mapping = aes(x = Green_Space_Deprivation_Rating,
                          y = prop_BAME_pop)
            )

p + geom_jitter(alpha = 0.5, colour = "grey75") +
  geom_boxplot(mapping = aes(fill = Green_Space_Deprivation_Rating), 
               alpha = 0.5, 
               size = 1.25,
               colour = "grey25") +
  
  scale_fill_brewer(type = "div",
                      palette = "RdYlGn",
                      direction = -1) +
  
  guides(fill = FALSE) +
  
  coord_flip()
  
```
```{r}
library(ggridges)

p <- ggplot(data = green_space,
            mapping = aes(y = Green_Space_Deprivation_Rating,
                          x = prop_BAME_pop,
                          fill = Green_Space_Deprivation_Rating)
            )

p + geom_density_ridges(alpha = 0.6, scale = 1.5) +
  scale_fill_brewer(type = "div",
                      palette = "RdYlGn",
                      direction = -1) 
```


# Wealth and green space deprivation

# Health and green space deprivation

## Covid and green space deprivation


# Archived code

![](../images/FOE_Fig_1.PNG)
```{r, eval=FALSE}


p <- ggplot(data = msoa_by_rating,
            mapping = aes(x = Green_Space_Deprivation_Rating, y = msoa_count)
            )

p + geom_segment(mapping = aes(x = Green_Space_Deprivation_Rating,
                               xend = Green_Space_Deprivation_Rating,
                               y = 750,
                               yend = msoa_count),
                 colour = "grey50",
                 size = 1.5
                 ) +
  
  geom_point(mapping = aes(fill = Green_Space_Deprivation_Rating),
             size = 7.5,
             shape = 21, 
             colour = "grey50", 
             stroke = 1.25
             ) +
  
  scale_fill_brewer(type = "div",
                    palette = "RdYlGn",
                    direction = -1) +
  
  
  labs(title = title_lab,
       subtitle = subtitle_lab,
       x = x_lab,
       y = y_lab,
       caption = caption_lab) +
  
  guides(fill = FALSE) +
  
  # facet_wrap(~ Green_Space_Deprivation_Rating) +
  
  coord_flip()
```